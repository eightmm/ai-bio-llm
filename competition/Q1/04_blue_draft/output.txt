## 1-1. Incident A — messy traces, variable yield, qPCR inefficiency, low A260/230

### Most likely root cause(s)
1) **Carryover of cleanup contaminants (salts/solvents/ethanol) into enzymatic steps**, consistent with:
- **Low A260/230** in some runs (classic signature of salt/solvent carryover).
- **Poor qPCR amplification efficiency and high Ct variance** (PCR is highly sensitive to ethanol/chaotropic salts).
- **Messy library traces (elevated baseline/smear + occasional small peaks)** that sometimes improve after repeating cleanup.

2) **Inconsistent bead/column cleanup behavior (operator- and environment-dependent)** leading to variable:
- Ethanol removal (under-dry → ethanol carryover → PCR inhibition),
- Bead over-dry / incomplete resuspension (yield loss + variable smear),
- Size-selection stringency (small peaks consistent with adapter/primer artifacts not fully removed).

### Next steps to confirm (no new wet-lab required)
1) **Correlate per-run A260/230 + qPCR curves + electropherogram features**:
- If inhibition is the driver, failed runs should show **right-shifted qPCR curves** (higher Ct) and low A260/230.
2) **Audit run notes for cleanup details** (even informal notes):
- air-dry duration, visible residual ethanol, aspiration technique, bead cracking/over-drying, elution conditions.
3) **Electropherogram triage**:
- Quantify “peak-to-smear” (even approximately) across runs; expect worst smears in low A260/230 runs.

### Fix + prevention
1) **Make cleanup steps explicit and unambiguous in the protocol** (this is a protocol/document defect if currently vague):
- Define bead drying by *appearance*: “dry until matte, not shiny; no visible droplets,” rather than time alone.
- Add a **mandatory quick-spin + re-place on magnet + remove residual ethanol** step before elution.
2) **Add a QC gate before PCR**:
- If A260/230 is available: require a minimum threshold (institution-specific; commonly ~1.8–2.2 for clean nucleic acid).
- If not: require a small **qPCR inhibition check** (e.g., spike a constant control template into a dilute aliquot and confirm expected Ct shift is small).
3) **If small peaks are adapter/primer artifacts**:
- Add/standardize a **second, size-selective cleanup** (bead ratio chosen to remove short species) and record the ratio used.

---

## 1-2. Incident B — operator-dependent PCR variability; rescued by extended bead air-dry

### Most likely root cause(s)
1) **Residual ethanol carried into PCR due to operator-dependent bead handling**, strongly supported by:
- “Extended bead air-dry (and careful removal of residual ethanol) restores normal amplification.”

2) Secondary contributor (less direct, but consistent): **incomplete bead resuspension / inconsistent mixing**, which can create variable recovery and variable inhibitor carryover.

### Next steps to confirm (no new wet-lab required)
1) **Compare operator-specific run notes** (even if reconstructed) for:
- air-dry approach, aspiration depth, whether tips touch pellet, whether they wait for full clearing on magnet.
2) **Inspect qPCR curve shapes**:
- Ethanol inhibition commonly presents as delayed Ct / reduced efficiency rather than complete absence of amplification (depending on severity).

### Fix + prevention
1) **Operator-proof the cleanup step in the protocol**:
- Replace ambiguous timing with **visual criteria** and a defined “do not exceed” to avoid over-drying.
- Add **standardized aspiration technique** (e.g., remove ethanol twice; rotate tube; avoid disturbing pellet).
2) **Training + qualification**:
- Require each operator to run a short “cleanup-only qualification” on a shared control library prep intermediate, with a pass/fail criterion based on qPCR performance and/or A260/230.
3) **Add an internal PCR control**:
- A small aliquot of a known-good library (or a standard DNA control) run alongside to distinguish “PCR setup/instrument issue” vs “sample inhibition”.

---

## 1-3. Incident C — broad fragment distribution (>40 nt), weak/absent 3-nt periodicity, more non-CDS mapping

### Most likely root cause(s)
1) **Under-digestion during nuclease footprinting and/or overly broad size selection**, consistent with:
- Protected fragments show **broad distribution with substantial >40 nt material**.
- Weak/absent **3-nt periodicity** (long/non-canonical fragments dilute periodicity).
- Increased mapping outside CDS (non-ribosomal RNP-protected fragments and partially digested mRNA contribute off-CDS signal).

2) Less directly supported (possible but not required by the observations): **monosome isolation issues** (e.g., incomplete separation of monosomes from other complexes), which can also broaden fragment profiles. The provided observations most directly implicate digestion/size-selection.

### Next steps to confirm (no new wet-lab required)
1) **From existing sequencing data, compute insert length distribution after trimming**:
- Quantify fraction in expected RPF window vs >40 nt.
2) **Length-stratified periodicity**:
- Compute 3-nt periodicity separately for “expected-length” reads vs longer reads.
- Under-digestion/broad selection typically shows periodicity concentrated (if at all) in the expected-length bin.
3) **Region-of-transcript distribution**:
- Using available CDS annotation (if known for toy datasets) or prior internal annotation, quantify CDS vs UTR mapping shift.

### Fix + prevention (recommended for future wet-lab runs)
1) **Add a nuclease digestion optimization/titration requirement** (documented as a mandatory setup step per organism/lysate type):
- Run a small titration series (e.g., 1×, 2×, 3× nuclease units or time) and pick the condition yielding a narrow footprint band.
2) **Tighten size selection**:
- Explicit gel excision window (or bead-based size selection) that excludes >40 nt fragments.
3) **Add acceptance gates before library prep continues**:
- “Proceed only if footprint QC shows dominant band in the expected range and minimal >40 nt.”

---

## 1-4. Incident D — dedup collapses almost everything; extremely low observed UMI diversity

### Most likely root cause(s)
1) **UMI extraction is wrong in the bioinformatics pipeline (wrong location/orientation/length)**, causing extraction of a constant or low-diversity sequence (e.g., adapter-derived bases) instead of true random Ns:
- “After UMI extraction, distinct UMIs observed is extremely small.”
- “UMI histogram concentrated in a tiny set; uniqueness saturates early.”
- This is the most common explanation when a protocol encodes a UMI but analysis collapses implausibly.

2) **Adapter/oligo synthesis/order issue leading to non-random ‘UMI’** (secondary possibility):
- If the oligo actually shipped without true random Ns (or with an unintended fixed motif), real UMI diversity would be low regardless of pipeline.

### Next steps to confirm (no new wet-lab required)
1) **Directly inspect raw FASTQ read starts/ends**:
- Identify where the protocol’s UMI (Ns) should be and check whether that region shows high diversity.
2) **Per-position base composition / entropy across the supposed UMI bases**:
- True UMIs should look approximately diverse at each UMI position; constant bases indicate wrong extraction.
3) **Reconcile protocol read-structure vs tool parameters**:
- Confirm the UMI length (number of Ns), whether it is at the 5′ end of Read 1, embedded after a linker, etc., and ensure extraction pattern matches.

### Fix + prevention
1) **Protocol documentation fix**: include an explicit read-structure diagram:
- `[5' linker][UMI (N bases)][insert][3' adapter]` with exact lengths/positions.
2) **Pipeline guardrails**:
- Add a hard-fail QC rule: if unique UMIs per N reads is below a minimum threshold (lab-defined), stop and report “UMI extraction likely incorrect.”
3) **If oligo issue suspected**:
- Audit adapter order paperwork for the UMI-containing oligo to confirm it contains true Ns and matches the intended molecule type/modifications.

---

## 1-5. Incident E — ligation fails (no band shift), libraries dominated by short artifacts, expected linker prefix rare, new oligo shipment differs

### Most likely root cause(s)
1) **Wrong adapter/linker oligo specification in the new shipment (molecule type, terminal modifications, or purification)**, causing ligation failure:
- Denaturing gel after ligation shows **no shifted product**.
- Final library dominated by **short artifacts** (adapter/primer products).
- Enzyme replacement does **not** reliably rescue (points away from ligase degradation).
- Sequencing shows enrichment of primer/adapter-like sequence at read starts and **low frequency of the expected linker-specific prefix**.
- Paperwork differs in molecule type/modifications/purification grade: strong evidence of a reagent-spec mismatch.

### Next steps to confirm (no new wet-lab required)
1) **Reagent forensics**:
- Compare old vs new oligo paperwork/CoA: molecule type (RNA vs DNA), 5′ phosphorylation/adenylation status, 3′ blocking group, purification (HPLC/PAGE vs desalted).
2) **Sequence forensic check using the FASTQ**:
- Count fraction of reads beginning with the expected linker prefix (from protocol) vs reads dominated by generic adapter/primer sequences.
3) **Protocol consistency check**:
- Verify whether the protocol explicitly specifies required oligo chemistry. If not, this is a protocol defect enabling substitution errors.

### Fix + prevention
1) **Add a “critical oligos” specification table to the protocol**:
- For each adapter/linker: exact sequence, molecule type, 5′/3′ modifications, purification grade, and “no substitutions without approval.”
2) **Incoming oligo QC gate**:
- Before use: confirm paperwork matches the spec; quarantine mismatched lots.
3) **Mandatory post-ligation checkpoint**:
- “Proceed only if ligated product band shift is observed relative to pre-ligation control.”

---

## 1-6. Preliminary data analysis (single-transcript pilot): processing plan, required outputs, QC report contents, interpretation, follow-ups

### Assumptions / limitations (explicit)
- The provided conversation does **not** include the contents of `protocol.md`, `reference.fa`, or `reads.fastq.gz`, and no executable environment is available here; therefore, **I cannot truthfully output computed `counts_raw.csv`, `counts_dedup.csv`, a real histogram figure, or a populated HTML report**.
- Below is an **execution-ready procedure** that (i) produces the required files/plots, (ii) states coordinate conventions, and (iii) defines QC metrics and interpretation criteria appropriate for Ribo-seq on a single transcript.

---

### Deliverable 1: `counts_raw.csv` and `counts_dedup.csv`

#### Coordinate convention (state this in the report and in file headers)
- Reference transcript coordinates are **0-based** with respect to the `reference.fa` sequence string:
  - Position `0` = first nucleotide (5′ end) of the transcript sequence in `reference.fa`
  - Position `L-1` = last nucleotide, where `L` is transcript length
- Footprint position is defined as the **aligned read 5′ start coordinate on the transcript** (for a single transcript reference, strand is typically implicit; if aligner reports reverse alignments, use the 5′ end in transcript coordinates after accounting for strand).

#### Processing steps (inputs → outputs)
1) **Read structure inference (from `protocol.md` + FASTQ)**
   - Input: `protocol.md`, `reads.fastq.gz`
   - Action:
     - Identify where the protocol places the UMI (random Ns) and adapters/linkers.
     - Independently verify by sampling ~50 reads and checking for constant motifs (adapter/linker) and a high-diversity window (UMI).
   - Output: a short “read-structure manifest” used for trimming + UMI extraction (documented in the HTML report).

2) **Adapter/linker trimming**
   - Input: `reads.fastq.gz`
   - Action:
     - Trim known 3′ adapter sequence.
     - If protocol includes a 5′ linker/prefix, trim/validate it (optionally require anchored match to reduce garbage).
   - Output: `trimmed.fastq.gz`

3) **UMI extraction**
   - Input: `trimmed.fastq.gz`
   - Action:
     - Extract the UMI bases exactly as specified (length and position).
     - Store UMI in read name (or SAM tag) for downstream dedup.
   - Output: `umi_extracted.fastq.gz`

4) **Alignment to the single transcript**
   - Input: `reference.fa`, `umi_extracted.fastq.gz`
   - Action:
     - Build an index for the single transcript.
     - Align reads (local alignment often appropriate if adapters may remain).
     - Keep primary alignments; filter very low-confidence alignments if MAPQ is available.
   - Output: `aligned.sorted.bam` (or equivalent)

5) **Per-position counting (raw)**
   - Input: `aligned.sorted.bam`
   - Action:
     - For each aligned read, compute transcript 5′ start coordinate `pos0`.
     - Increment `raw_count[pos0] += 1`.
   - Output: `counts_raw.csv` with columns:
     - `pos0,raw_reads`
     - Include all positions 0..L-1 (preferred for a “count array”), filling zeros, **or** include only nonzero positions (acceptable if documented).

6) **Per-position counting (deduplicated using UMI)**
   - Input: `aligned.sorted.bam` with UMI per read
   - Action:
     - Define a unique molecule key as `(pos0, UMI)` (and strand if relevant).
     - Deduplicate by collapsing reads with identical keys to one molecule.
     - Count molecules per position: `dedup_count[pos0] = number of unique UMIs observed at pos0`.
   - Output: `counts_dedup.csv` with columns:
     - `pos0,unique_molecules`
     - (Optional but useful) additional columns:
       - `raw_reads_at_pos0` (to show duplication per site)
       - `n_umis_at_pos0` (same as unique_molecules)
       - `top_umi_fraction_at_pos0` (dominance check)

---

### Deliverable 2: Histogram plot of 5′ start positions (raw vs deduplicated)

#### What to plot
- X-axis: `pos0` (0..L-1)
- Y-axis: counts
- Two panels side-by-side (or overlaid with transparency):
  - Panel A: `raw_reads` from `counts_raw.csv`
  - Panel B: `unique_molecules` from `counts_dedup.csv`

#### What the plot diagnoses in this toy dataset
- **Sharp single-position spikes in raw that vanish after dedup** → PCR duplication/jackpot at specific start sites.
- **Nearly identical raw and dedup** → low duplication or failed UMI usage (depending on overall UMI diversity).
- **Coverage concentrated in a narrow transcript region** → potential strong ribosome occupancy *or* mapping/trimming artifact (must check adapters/lengths).

---

### Deliverable 3: Single HTML report (QC + interpretation)

Include the following sections and computed metrics (all from the steps above):

1) **Input summary**
- Total reads in FASTQ
- Read length (expected 50 nt raw, per prompt)
- Fraction passing trimming filters

2) **Read structure validation**
- Most common 5′ prefixes / 3′ suffixes (k-mer counts)
- Evidence that UMI region is high-diversity (per-position base composition/entropy across UMI bases)

3) **Insert length distribution after trimming**
- Histogram of trimmed insert lengths
- Fraction in an “expected footprint window” (you must define the window you apply; typical is ~28–34 nt, but state it as a QC expectation, not as guaranteed truth for this dataset)

4) **Alignment QC**
- Mapping rate to `toy_gene`
- Distribution of alignment start positions (this is the same as the requested histogram, but summarize)

5) **UMI / duplication QC**
- Number of unique UMIs overall
- Unique UMIs per 1,000 reads (a simple complexity indicator)
- Deduplication rate: `1 - (total_dedup_molecules / total_mapped_reads)`

6) **Ribo-seq–specific interpretability checks (single transcript)**
- If CDS coordinates are known (from the toy reference design) or provided elsewhere: compute **frame preference / 3-nt periodicity** of 5′ starts (or P-site–shifted positions if an offset is defined).
- If CDS coordinates are *not* available: explicitly state that true periodicity cannot be interpreted biologically without an ORF annotation, and limit to coverage/length/UMI QC.

---

### Deliverable 4: Written interpretation + 2–4 concrete follow-up checks

#### What (if anything) looks biologically meaningful (how to decide, given this dataset)
- Biologically meaningful Ribo-seq signal on a transcript typically requires:
  1) Insert lengths concentrated in a footprint-like range (narrow, not broad),
  2) Start-position distribution that is not dominated by adapter artifacts,
  3) Reasonable UMI diversity (dedup does not collapse everything to a tiny set),
  4) If CDS annotation exists: detectable 3-nt periodicity in the dominant footprint lengths.

Because the actual computed metrics are not available here, your interpretation section in the HTML report should explicitly classify the dataset into one of these outcomes based on the QC numbers you compute:
- **Pass-like**: narrow length distribution + good UMI diversity + periodicity (if assessable)
- **Wet-lab failure-like**: broad lengths / adapter contamination pattern / no periodicity
- **Bioinformatics/UMI failure-like**: mapping OK but UMIs low-diversity or dedup collapse implausibly

#### 2–4 concrete follow-up checks / next steps (computational; supported by the problem constraints)
1) **UMI correctness check (high priority)**  
   Compute per-position entropy of the extracted UMI bases and list the top 20 UMIs by frequency. If UMIs are nearly constant, revisit extraction coordinates/pattern and/or adapter spec (connects directly to Incident D).

2) **Length-stratified start-position histograms**  
   Recompute start-position distributions separately for reads in the expected footprint range vs longer reads. If only one length bin shows structured occupancy, that distinguishes RPF-like signal from contamination (connects to Incident C).

3) **Adapter/linker presence audit in raw reads**  
   Quantify how many reads contain the expected protocol linker prefix and/or 3′ adapter sequence. A low prefix frequency or high adapter content supports a ligation/library construction issue (connects to Incident E).

4) **Sensitivity analysis of alignment/trimming settings**  
   Repeat the pipeline with a slightly stricter trimming rule (anchored adapter match; minimum insert length) and confirm that the main occupancy pattern is stable. If patterns change drastically, the signal is likely driven by preprocessing artifacts.

---

## Cross-incident validation & prevention plan (protocol-level; applies to A–E)
1) **Stage-gated QC checkpoints** (do not proceed if failed):
- Post-cleanup inhibitor check (A260/230 or qPCR inhibition proxy)
- Post-digestion footprint size distribution gate (exclude broad >40 nt dominance)
- Post-ligation band-shift check
- Pre-sequencing library trace gate (dominant expected peak; limited short artifacts)
- Post-sequencing UMI complexity gate + periodicity gate (if CDS known)

2) **Protocol hardening**
- Replace ambiguous steps (especially bead drying and oligo specs) with explicit criteria.
- Add a read-structure diagram with exact UMI placement and required extraction settings.

3) **Operator standardization**
- Checklist-driven execution for the most sensitive steps (cleanup drying/aspiration; digestion timing/temperature; ligation setup).
- Require at least one successful control run per operator before processing valuable samples.